



<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
    
    <script language="JavaScript">
  ak = "Y2JjZDg5MzE5YTUwYjYzMTYyNzFmNGMzZDc5OWM2NTc="
</script>
    <meta charset="utf-8">
<link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
<meta http-equiv="x-ua-compatible" content="ie=edge">


<meta itemprop="name" content="http4k blog: Nanoservices: The Power of Composition">
<meta name="twitter:title" content="http4k blog: Nanoservices: The Power of Composition">
<meta property="og:title" content="http4k blog: Nanoservices: The Power of Composition" />



<meta name="description" content="You thought that microservices were a thing? Pah! The powerful abstractions in the http4k toolkit allow you to write entire useful apps which fit in a Tweet.">
<meta property="og:description" content="You thought that microservices were a thing? Pah! The powerful abstractions in the http4k toolkit allow you to write entire useful apps which fit in a Tweet." />
<meta name="twitter:description" content="You thought that microservices were a thing? Pah! The powerful abstractions in the http4k toolkit allow you to write entire useful apps which fit in a Tweet.">



<link rel="canonical" href="https://www.http4k.org/blog/nanoservices/">



<meta name="author" content="David Denton (@daviddenton), Ivan Sanchez (@s4nchez)">
<meta name="twitter:creator" content="David Denton (@daviddenton), Ivan Sanchez (@s4nchez)">




<meta name="lang:clipboard.copy" content="en">

<meta name="lang:clipboard.copied" content="en">

<meta name="lang:search.language" content="en">

<meta name="lang:search.pipeline.stopwords" content="en">

<meta name="lang:search.pipeline.trimmer" content="en">

<meta name="lang:search.result.none" content="en">

<meta name="lang:search.result.one" content="en">

<meta name="lang:search.result.other" content="en">

<meta name="lang:search.tokenizer" content="en">

<!-- ****** faviconit.com favicons ****** -->
<link rel="shortcut icon" href="/img/favicon.ico">
<link rel="icon" sizes="16x16 32x32 64x64" href="/img/favicon.ico">
<link rel="icon" type="image/png" sizes="196x196" href="/img/favicon-192.png">
<link rel="icon" type="image/png" sizes="160x160" href="/img/favicon-160.png">
<link rel="icon" type="image/png" sizes="96x96" href="/img/favicon-96.png">
<link rel="icon" type="image/png" sizes="64x64" href="/img/favicon-64.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16.png">
<link rel="apple-touch-icon" href="/img/favicon-57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/img/favicon-114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/img/favicon-72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/img/favicon-144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/img/favicon-60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/img/favicon-120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/img/favicon-76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/img/favicon-152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/img/favicon-180.png">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="msapplication-TileImage" content="/img/favicon-144.png">
<meta name="msapplication-config" content="/img/browserconfig.xml">
<!-- ****** faviconit.com favicons ****** -->
<meta name="generator" content="mkdocs-1.2.3, mkdocs-material-3.0.4">
    
    
    
    <title>http4k blog: Nanoservices: The Power of Composition</title>
    
    
    
    
    
    
    <meta name="theme-color" content="#4051b5">
    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/codehilite.css"/>
    
    
    
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&amp;display=swap" rel="stylesheet"/>
    
    
    <link rel="stylesheet" href="/css/main.css"/>
    
    <link rel="stylesheet" href="../../css/site.css">
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
</head>



<body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="blue">







<div class="intro">
    <div class="row no-gutters justify-content-center">
        <div class="aside col-auto">
    <img class="mb-3 sideToggle d-inline-block d-md-none" src="/img/exchange-icon.svg" width="20" alt="" srcset=""/>
    <a href="/">
        <div class="logo"><img src="/img/logo-intro.png" width="185" alt="logo" srcset=""/></div>
    </a>
    <ul class="nav flex-column">
        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../documentation/"
               title="Introduction">Introduction</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../quickstart/"
               title="Quickstart">Quickstart</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../guide/"
               title="About the docs">About the docs</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item dropdown ">
            <a class="nav-link dropdown-toggle "
               data-toggle="dropdown"
               href="#"
               role="button"
               aria-haspopup="true"
               aria-expanded="false">Concepts</a>
            <div class="dropdown-menu ">
            
            
            
    
        <a class="dropdown-item "
           href="../../guide/concepts/rationale/"
           title="Rationale">Rationale</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/concepts/http/"
           title="HTTP">HTTP</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/concepts/serverless/"
           title="Serverless">Serverless</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/concepts/websockets/"
           title="WebSockets">WebSockets</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/concepts/server-sent-events/"
           title="Server-Sent Events">Server-Sent Events</a>
    

            
            </div>
        </li>
    

        
        
        
        
    
        <li class="nav-item dropdown ">
            <a class="nav-link dropdown-toggle "
               data-toggle="dropdown"
               href="#"
               role="button"
               aria-haspopup="true"
               aria-expanded="false">Tutorials</a>
            <div class="dropdown-menu ">
            
            
            
    
        <a class="dropdown-item "
           href="../../guide/tutorials/your_first_http4k_app/"
           title="Your first http4k app">Your first http4k app</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/tutorials/serverless_http4k_with_aws_lambda/"
           title="Deploying an http4k app to AWS Lambda">Deploying an http4k app to AWS Lambda</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/tutorials/going_native_with_graal_on_aws_lambda/"
           title="Going native with Graal on AWS Lambda">Going native with Graal on AWS Lambda</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/tutorials/tdding_http4k/"
           title="TDDing http4k">TDDing http4k</a>
    

            
            </div>
        </li>
    

        
        
        
        
    
        <li class="nav-item dropdown ">
            <a class="nav-link dropdown-toggle "
               data-toggle="dropdown"
               href="#"
               role="button"
               aria-haspopup="true"
               aria-expanded="false">How-to guides</a>
            <div class="dropdown-menu ">
            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/"
           title="Overview">Overview</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/server_as_a_function/"
           title="Basic: Server as a function">Basic: Server as a function</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/client_as_a_function/"
           title="Basic: Client as a function">Basic: Client as a function</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/use_a_server_backend/"
           title="Basic: Use a Server backend">Basic: Use a Server backend</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/write_different_test_types/"
           title="Basic: Different test-types">Basic: Different test-types</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/simple_routing/"
           title="Basic: Simple routing">Basic: Simple routing</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/nestable_routes/"
           title="Basic: Nestable routes">Basic: Nestable routes</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/attach_context_to_a_request/"
           title="Attach context to a request">Attach context to a request</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/configure_an_oauth_server/"
           title="Configure an OAuth Server">Configure an OAuth Server</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/create_a_custom_json_marshaller/"
           title="Create a custom JSON marshaller">Create a custom JSON marshaller</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/customise_a_server_backend/"
           title="Customise a Server backend">Customise a Server backend</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/deploy_webjars/"
           title="Deploy WebJars">Deploy WebJars</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/integrate_with_openapi/"
           title="Integrate with OpenAPI">Integrate with OpenAPI</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/leverage_graphql/"
           title="Leverage GraphQL">Leverage GraphQL</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/lookup_a_user_principal/"
           title="Lookup a User Principal">Lookup a User Principal</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/monitor_http4k/"
           title="Monitor http4k">Monitor http4k</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/record_and_replay_http_traffic/"
           title="Record & replay HTTP traffic">Record & replay HTTP traffic</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/serve_sse/"
           title="Serve Server-Sent Events">Serve Server-Sent Events</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/serve_websockets/"
           title="Serve Websockets">Serve Websockets</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/structure_your_logs_with_events/"
           title="Structure your logs with Events">Structure your logs with Events</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/test_using_service_virtualisation/"
           title="Test using Service Virtualisation">Test using Service Virtualisation</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/typesafe_your_api_with_lenses/"
           title="Typesafe your API with lenses">Typesafe your API with lenses</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/secure_and_auth_http/"
           title="Secure and auth HTTP services">Secure and auth HTTP services</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/use_a_custom_oauth_provider/"
           title="Use a custom OAuth Provider">Use a custom OAuth Provider</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/use_a_templating_engine/"
           title="Use a templating engines">Use a templating engines</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/use_html_forms/"
           title="Use HTML forms">Use HTML forms</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/use_multipart_forms/"
           title="Use Multipart forms">Use Multipart forms</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/self_document_systems_with_tests/"
           title="Self document systems with tests">Self document systems with tests</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/use_auto_content_negotiation/"
           title="Use Auto Content Negotiation">Use Auto Content Negotiation</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/create_a_swagger_ui/"
           title="Create a Swagger UI">Create a Swagger UI</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/howto/moshi_lite/"
           title="Use Moshi with "lite" Reflection">Use Moshi with "lite" Reflection</a>
    

            
            </div>
        </li>
    

        
        
        
        
    
        <li class="nav-item dropdown ">
            <a class="nav-link dropdown-toggle "
               data-toggle="dropdown"
               href="#"
               role="button"
               aria-haspopup="true"
               aria-expanded="false">Reference</a>
            <div class="dropdown-menu ">
            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/"
           title="Overview">Overview</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../api/"
           title="API docs">API docs</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/core/"
           title="Core">Core</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/servers/"
           title="Server backend">Server backend</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/serverless/"
           title="Serverless backend">Serverless backend</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/clients/"
           title="HTTP & Websocket clients">HTTP & Websocket clients</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/contracts/"
           title="Typesafe contracts (OpenAPI3)">Typesafe contracts (OpenAPI3)</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/json/"
           title="JSON handling">JSON handling</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/templating/"
           title="Templating">Templating</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/multipart/"
           title="Multipart forms">Multipart forms</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/cloud_native/"
           title="Cloud Native Configuration">Cloud Native Configuration</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/cloud_events/"
           title="Cloud Events">Cloud Events</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/micrometer/"
           title="Micrometer">Micrometer</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/opentelemetry/"
           title="OpenTelemetry">OpenTelemetry</a>
    

            
            
            
    
        <a class="dropdown-item nav-link dropdown-toggle  "
            data-toggle="dropdown"
            href="#"
            role="button"
            aria-haspopup="true"
            aria-expanded="false"> Fault Tolerance</a>
        <div class="dropdown-menu ">
            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/resilience4j/"
           title="Resilience4J">Resilience4J</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/failsafe/"
           title="Failsafe">Failsafe</a>
    

            
        </div>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/aws/"
           title="AWS">AWS</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/oauth/"
           title="OAuth">OAuth</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/graphql/"
           title="GraphQL">GraphQL</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/jsonrpc/"
           title="JSON RPC">JSON RPC</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/xml/"
           title="XML handling">XML handling</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/yaml/"
           title="YAML handling">YAML handling</a>
    

            
            
            
    
        <a class="dropdown-item nav-link dropdown-toggle  "
            data-toggle="dropdown"
            href="#"
            role="button"
            aria-haspopup="true"
            aria-expanded="false"> Testing</a>
        <div class="dropdown-menu ">
            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/testing/"
           title="Overview">Overview</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/approvaltests/"
           title="Approval Testing">Approval Testing</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/chaos/"
           title="Chaos Testing">Chaos Testing</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/hamkrest/"
           title="Hamkrest">Hamkrest</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/kotest/"
           title="Kotest">Kotest</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/servicevirtualisation/"
           title="Service Virtualisation">Service Virtualisation</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/strikt/"
           title="Strikt">Strikt</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../../guide/reference/webdriver/"
           title="WebDriver">WebDriver</a>
    

            
        </div>
    

            
            </div>
        </li>
    

        
        
        
        
    
        <li class="nav-item dropdown active show">
            <a class="nav-link dropdown-toggle active"
               data-toggle="dropdown"
               href="#"
               role="button"
               aria-haspopup="true"
               aria-expanded="true">Blog</a>
            <div class="dropdown-menu show">
            
            
            
    
        <a class="dropdown-item "
           href="../"
           title="Overview">Overview</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../meet_http4k/"
           title="Meet http4k">Meet http4k</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../typesafe_websockets/"
           title="Typesafe Websockets">Typesafe Websockets</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../typesafe_configuration/"
           title="Typesafe 12-factor config">Typesafe 12-factor config</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../documenting_apis_with_openapi/"
           title="Documenting http4k apps with OpenApi3">Documenting http4k apps with OpenApi3</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../retrospective_v3/"
           title="Retrospective on v3">Retrospective on v3</a>
    

            
            
            
    
        <a class="dropdown-item active"
           href="./"
           title="Nanoservices">Nanoservices</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../toolbox/"
           title="Toolbox: Guns for show, knives for a pro">Toolbox: Guns for show, knives for a pro</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../http4k_v4/"
           title="http4k v4 - 17 platforms and counting...">http4k v4 - 17 platforms and counting...</a>
    

            
            
            
    
        <a class="dropdown-item "
           href="../regarding_jcenter/"
           title="JCenter Shutdown">JCenter Shutdown</a>
    

            
            </div>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../changelog/"
               title="Changelog">Changelog</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../in_action/"
               title="http4k in action">http4k in action</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../performance/"
               title="Performance">Performance</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../faq/"
               title="FAQ">FAQ</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../support/"
               title="Getting support">Getting support</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../contributing/"
               title="Contribute/support http4k">Contribute/support http4k</a>
        </li>
    

        
        
        
        
    
        <li class="nav-item">
            <a class="nav-link "
               href="../../code-of-conduct/"
               title="Code of Conduct">Code of Conduct</a>
        </li>
    

        
        <li class="nav-item">
            <a class="nav-link" href="https://github.com/http4k/http4k">
                <img src="/img/GitHub-Mark-black.png" width="28" alt="See source on GitHub">&nbsp;&nbsp;Source Code</a>
        </li>
    </ul>
</div>
        <main class="col">
          <div class="container">
                <div class="searchBox">
                  <img class="searchBoxIcon" src="/img/search-icon.svg" width="20" alt="" srcset=""/>
                  <input id="search" type="text" />
                </div>
                <div class="content">
                    <img class="mb-3 sideToggle" src="/img/exchange-icon.svg" width="20" alt="" srcset=""/>
                    
                    
                    <h1 id="nanoservices_the_power_of_composition">Nanoservices: The Power of Composition<a class="headerlink" href="#nanoservices_the_power_of_composition" title="Permanent link">&para;</a></h1>
<h5 id="october_2020_daviddenton">october 2020 / <a href="http://github.com/daviddenton">@daviddenton</a><a class="headerlink" href="#october_2020_daviddenton" title="Permanent link">&para;</a></h5>
<p>http4k is a small library with a zero dependencies (apart from Kotlin StdLib), but what really makes it shine is the power afforded by the combination of the "Server as a Function" concepts of <code>HttpHandler</code> and <code>Filter</code>. </p>
<p>Skeptical? We would be disappointed if you weren't! Hence, we decided to prove the types of things that can be accomplished with the APIs provided by http4k and a little ingenuity.</p>
<p>For each of the examples below, there is a fully formed http4k application declared inside a function, and the scaffolding to demonstrating it working in an accompanying <code>main()</code> using one of the swappable server backends. Even better, each of app's code (excluding import statements 🙂 ) fits in a single Tweet.</p>
<h3 id="1_build_a_simple_proxy">1. Build a simple proxy <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/simple_proxy.kt"><img class="octocat"/></a><a class="headerlink" href="#1_build_a_simple_proxy" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code></p>
<p>This simple proxy converts HTTP requests to HTTPS. Because of the symmetrical server/client <code>HttpHandler</code> signature, we can simply pipe an HTTP Client onto a server, then add a <code>ProxyHost</code> filter to do the protocol conversion.</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.JavaHttpClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Request</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.SunHttp</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.lang.System.setProperty</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`simple proxy`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">JavaHttpClient</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">asServer</span><span class="p">(</span><span class="n">SunHttp</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">start</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyHost&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyPort&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.nonProxyHosts&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">`simple proxy`</span><span class="p">().</span><span class="na">use</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">JavaHttpClient</span><span class="p">()(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://github.com/&quot;</span><span class="p">)))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<h3 id="2_report_latency_through_a_proxy">2. Report latency through a proxy <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/latency_reporting_proxy.kt"><img class="octocat"/></a><a class="headerlink" href="#2_report_latency_through_a_proxy" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code></p>
<p>Building on the Simple Proxy example, we can simply layer on extra filters to add features to the proxy, in this case reporting the latency of each call.</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.JavaHttpClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Request</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.then</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyHost</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyProtocolMode.Https</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.ResponseFilters.ReportRouteLatency</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.SunHttp</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.lang.System.setProperty</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`latency reporting proxy`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">ProxyHost</span><span class="p">(</span><span class="n">Https</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">ReportRouteLatency</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;</span><span class="si">$</span><span class="n">req</span><span class="s"> took </span><span class="si">$</span><span class="n">ms</span><span class="s">&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">JavaHttpClient</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">asServer</span><span class="p">(</span><span class="n">SunHttp</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">start</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyHost&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyPort&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.nonProxyHosts&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">`latency reporting proxy`</span><span class="p">().</span><span class="na">use</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JavaHttpClient</span><span class="p">()(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://github.com/&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<h3 id="3_build_a_wireshark_to_sniff_inter-service_traffic">3. Build a Wireshark to sniff inter-service traffic <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/wire_sniffing_proxy.kt"><img class="octocat"/></a><a class="headerlink" href="#3_build_a_wireshark_to_sniff_inter-service_traffic" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code></p>
<p>Applying a <code>DebuggingFilter</code> to the HTTP calls in a proxy dumps the entire contents out to <code>StdOut</code> (or other stream).</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.JavaHttpClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Request</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.then</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.DebuggingFilters.PrintRequestAndResponse</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyHost</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyProtocolMode.Https</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.SunHttp</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.lang.System.setProperty</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`wire sniffing proxy`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">ProxyHost</span><span class="p">(</span><span class="n">Https</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">PrintRequestAndResponse</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">JavaHttpClient</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">asServer</span><span class="p">(</span><span class="n">SunHttp</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">start</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyHost&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyPort&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.nonProxyHosts&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">`wire sniffing proxy`</span><span class="p">().</span><span class="na">use</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JavaHttpClient</span><span class="p">()(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://github.com/http4k&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<h3 id="4_build_a_ticking_websocket_clock">4. Build a ticking Websocket clock <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/websocket_clock.kt"><img class="octocat"/></a><a class="headerlink" href="#4_build_a_ticking_websocket_clock" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code>, <code>http4k-server-netty</code></p>
<p>Like HTTP handlers, Websockets in http4k can be modelled as simple functions that can be mounted onto a Server, or combined with path patterns if required.</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.WebsocketClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Uri</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.Netty</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.websocket.Websocket</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.websocket.WsMessage</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.time.Instant</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`ticking websocket clock`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">ws</span><span class="p">:</span><span class="w"> </span><span class="n">Websocket</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ws</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">WsMessage</span><span class="p">(</span><span class="n">Instant</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">toString</span><span class="p">()))</span>
<span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}.</span><span class="na">asServer</span><span class="p">(</span><span class="n">Netty</span><span class="p">()).</span><span class="na">start</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">`ticking websocket clock`</span><span class="p">()</span>
<span class="w">    </span><span class="n">WebsocketClient</span><span class="p">.</span><span class="na">nonBlocking</span><span class="p">(</span><span class="n">Uri</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;http://localhost:8000&quot;</span><span class="p">)).</span><span class="na">onMessage</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="nb">it</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<h3 id="5_build_a_web_cache">5. Build a web cache <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/disk_cache.kt"><img class="octocat"/></a><a class="headerlink" href="#5_build_a_web_cache" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code>, <code>http4k-server-ktorcio</code></p>
<p>Recording all traffic to disk can be achieved by just creating a <code>ReadWriteCache</code> and then adding a couple of pre-supplied Filters to a proxy. When running this example you can see that only the first request is audited.</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.JavaHttpClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Request</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.then</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyHost</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyProtocolMode.Https</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.ResponseFilters.ReportHttpTransaction</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.TrafficFilters.RecordTo</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.TrafficFilters.ServeCachedFrom</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.Http4kServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.KtorCIO</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.traffic.ReadWriteCache</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.io.File</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`disk cache!`</span><span class="p">(</span><span class="n">dir</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">):</span><span class="w"> </span><span class="n">Http4kServer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadWriteCache</span><span class="p">.</span><span class="na">Disk</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ProxyHost</span><span class="p">(</span><span class="n">Https</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">RecordTo</span><span class="p">(</span><span class="n">cache</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">ServeCachedFrom</span><span class="p">(</span><span class="n">cache</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">ReportHttpTransaction</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">request</span><span class="p">.</span><span class="na">uri</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">JavaHttpClient</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">asServer</span><span class="p">(</span><span class="n">KtorCIO</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">start</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyHost&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyPort&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;http.nonProxyHosts&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JavaHttpClient</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;store&quot;</span>
<span class="w">    </span><span class="n">File</span><span class="p">(</span><span class="n">dir</span><span class="p">).</span><span class="na">deleteRecursively</span><span class="p">()</span>

<span class="w">    </span><span class="n">`disk cache!`</span><span class="p">(</span><span class="n">dir</span><span class="p">).</span><span class="na">use</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://api.github.com/users/http4k&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">client</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="na">bodyString</span><span class="p">())</span>

<span class="w">        </span><span class="c1">// this request is served from the cache, so will not generate a call</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">client</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="na">bodyString</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<h3 id="6_record_all_traffic_to_disk_and_replay_it_later">6. Record all traffic to disk and replay it later <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/record_and_replay_http_traffic_proxy.kt"><img class="octocat"/></a><a class="headerlink" href="#6_record_all_traffic_to_disk_and_replay_it_later" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code></p>
<p>This example contains two apps. The first is a proxy which captures streams of traffic and records it to a directory on disk. The second app is configured to replay the requests from that disk store at the original server. This kind of traffic capture/replay is very useful for load testing or for tracking down hard-to-diagnose bugs - and it's easy to write other other stores such as an S3 bucket etc.</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.JavaHttpClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Request</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.then</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyHost</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyProtocolMode.Https</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.TrafficFilters.RecordTo</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.SunHttp</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.traffic.ReadWriteStream.Companion.Disk</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.lang.System.setProperty</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`recording traffic to disk proxy`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">ProxyHost</span><span class="p">(</span><span class="n">Https</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">RecordTo</span><span class="p">(</span><span class="n">Disk</span><span class="p">(</span><span class="s">&quot;store&quot;</span><span class="p">)))</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">JavaHttpClient</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">asServer</span><span class="p">(</span><span class="n">SunHttp</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">start</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`replay previously recorded traffic from a disk store`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">JavaHttpClient</span><span class="p">().</span><span class="na">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">Disk</span><span class="p">(</span><span class="s">&quot;store&quot;</span><span class="p">).</span><span class="na">requests</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">forEach</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">println</span><span class="p">(</span><span class="nb">it</span><span class="p">)</span>
<span class="w">                </span><span class="n">client</span><span class="p">(</span><span class="nb">it</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyHost&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyPort&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.nonProxyHosts&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">`recording traffic to disk proxy`</span><span class="p">().</span><span class="na">use</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JavaHttpClient</span><span class="p">()(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://github.com/&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="n">JavaHttpClient</span><span class="p">()(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://github.com/http4k&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="n">JavaHttpClient</span><span class="p">()(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://github.com/http4k/http4k&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">`replay previously recorded traffic from a disk store`</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<h3 id="7_watch_your_fs_for_file_changes">7. Watch your FS for file changes <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/file_watcher.kt"><img class="octocat"/></a><a class="headerlink" href="#7_watch_your_fs_for_file_changes" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code>, <code>http4k-server-jetty</code></p>
<p>Back to Websockets, we can watch the file system for changes and subscribe to the event feed.</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.WebsocketClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Uri</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.Jetty</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.websocket.Websocket</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.websocket.WsMessage</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.nio.file.FileSystems.getDefault</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.nio.file.Paths</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.nio.file.StandardWatchEventKinds.ENTRY_MODIFY</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`file watcher`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">ws</span><span class="p">:</span><span class="w"> </span><span class="n">Websocket</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDefault</span><span class="p">().</span><span class="na">newWatchService</span><span class="p">()</span>
<span class="w">        </span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">).</span><span class="na">register</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">ENTRY_MODIFY</span><span class="p">)</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="na">take</span><span class="p">()</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">            </span><span class="n">key</span><span class="p">.</span><span class="na">pollEvents</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">forEach</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ws</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">WsMessage</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">context</span><span class="p">().</span><span class="na">toString</span><span class="p">()))</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}.</span><span class="na">asServer</span><span class="p">(</span><span class="n">Jetty</span><span class="p">()).</span><span class="na">start</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">`file watcher`</span><span class="p">()</span>
<span class="w">    </span><span class="n">WebsocketClient</span><span class="p">.</span><span class="na">nonBlocking</span><span class="p">(</span><span class="n">Uri</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;http://localhost:8000&quot;</span><span class="p">)).</span><span class="na">onMessage</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="nb">it</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<h3 id="8_serve_static_files_from_disk">8. Serve static files from disk <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/static_file_server.kt"><img class="octocat"/></a><a class="headerlink" href="#8_serve_static_files_from_disk" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code>, <code>http4k-server-undertow</code></p>
<p>Longer than the Python <code>SimpleHttpServer</code>, but still pretty small!</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.JavaHttpClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Request</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.routing.ResourceLoader.Companion.Directory</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.routing.static</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.Undertow</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`static file server`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">static</span><span class="p">(</span><span class="n">Directory</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">asServer</span><span class="p">(</span><span class="n">Undertow</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">start</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">`static file server`</span><span class="p">().</span><span class="na">use</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// by default, static servers will only serve known file types,</span>
<span class="w">        </span><span class="c1">// or those registered on construction</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">JavaHttpClient</span><span class="p">()(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://localhost:8000/version.json&quot;</span><span class="p">)))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<h3 id="9_build_your_own_chaosmonkey">9. Build your own ChaosMonkey <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/chaos_proxy.kt"><img class="octocat"/></a><a class="headerlink" href="#9_build_your_own_chaosmonkey" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code>, <code>http4k-testing-chaos</code></p>
<p>As per the [Principles of Chaos], this proxy adds Chaotic behaviour to a remote service, which is useful for modelling how a system might behave under various failure modes. Chaos can be dynamically injected via an <code>OpenApi</code> documented set of RPC endpoints.</p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.chaos.ChaosBehaviours.Latency</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.chaos.ChaosEngine</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.chaos.withChaosApi</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.JavaHttpClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Method.GET</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Method.POST</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Request</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.then</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyHost</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.filter.RequestFilters.ProxyProtocolMode.Https</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.SunHttp</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.lang.System.setProperty</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`latency injection proxy (between 100ms-500ms)`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">ProxyHost</span><span class="p">(</span><span class="n">Https</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">then</span><span class="p">(</span><span class="n">JavaHttpClient</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">withChaosApi</span><span class="p">(</span><span class="n">ChaosEngine</span><span class="p">(</span><span class="n">Latency</span><span class="p">()).</span><span class="na">enable</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">asServer</span><span class="p">(</span><span class="n">SunHttp</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="na">start</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyHost&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.proxyPort&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;8000&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">setProperty</span><span class="p">(</span><span class="s">&quot;http.nonProxyHosts&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">`latency injection proxy (between 100ms-500ms)`</span><span class="p">().</span><span class="na">use</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">JavaHttpClient</span><span class="p">()(</span><span class="n">Request</span><span class="p">(</span><span class="n">POST</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://localhost:8000/chaos/activate&quot;</span><span class="p">)))</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">JavaHttpClient</span><span class="p">()(</span><span class="n">Request</span><span class="p">(</span><span class="n">GET</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;http://github.com/&quot;</span><span class="p">)).</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;X-http4k-chaos&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<h3 id="10_build_a_remote_terminal">10. Build a remote terminal! <a href="https://github.com/http4k/http4k/blob/master/src/docs/blog/nanoservices/web_terminal.kt"><img class="octocat"/></a><a class="headerlink" href="#10_build_a_remote_terminal" title="Permanent link">&para;</a></h3>
<p>Requires: <code>http4k-core</code>, <code>http4k-server-netty</code></p>
<p>Use Websockets to remote control a terminal!* Run the example and just type commands into the prompt to have them magicked to the server backend</p>
<p><sub>*Obviously this is, in general, a really (really) bad idea.</sub></p>
<div class="codehilite"><pre><span></span><code><span class="k">package</span><span class="w"> </span><span class="nn">blog.nanoservices</span>

<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.client.WebsocketClient</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.core.Uri</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.Netty</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.server.asServer</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.websocket.Websocket</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.http4k.websocket.WsMessage</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.lang.Runtime.getRuntime</span>
<span class="k">import</span><span class="w"> </span><span class="nn">java.util.Scanner</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">`websocket terminal`</span><span class="p">()</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">ws</span><span class="p">:</span><span class="w"> </span><span class="n">Websocket</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">ws</span><span class="p">.</span><span class="na">onMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">bodyString</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">inputStream</span>
<span class="w">                </span><span class="p">.</span><span class="na">reader</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">readText</span><span class="p">()</span>

<span class="w">            </span><span class="n">ws</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">WsMessage</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}.</span><span class="na">asServer</span><span class="p">(</span><span class="n">Netty</span><span class="p">()).</span><span class="na">start</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">`websocket terminal`</span><span class="p">()</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WebsocketClient</span><span class="p">.</span><span class="na">nonBlocking</span><span class="p">(</span><span class="n">Uri</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;http://localhost:8000&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="n">ws</span><span class="p">.</span><span class="na">onMessage</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="nb">it</span><span class="p">.</span><span class="na">bodyString</span><span class="p">())</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">scan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Scanner</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">`in`</span><span class="p">)</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ws</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">WsMessage</span><span class="p">(</span><span class="n">scan</span><span class="p">.</span><span class="na">nextLine</span><span class="p">()))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr/>

<p>Obviously we haven't thought of everything here. We'd love to hear your ideas about other clever uses of the http4k building blocks, or to take PRs to integrate them into the library for wider use. You can get in touch through <a href="http://github.com/http4k">GitHub</a> or the usual <a href="https://www.http4k.org/support">channels</a>.</p>
<p><a href="https://principlesofchaos.org/">Principles of Chaos</a></p>
                    
                </div>
            </div>
        </main>
    </div>
</div>
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/index-min.js"></script>
<script src="../../assets/javascripts/toggle-search.js"></script>

      <script src="../../assets/javascripts/application.583bbe55.js"></script>









<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-125143867-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
  apiKey: atob(ak),
  indexName: 'http4k',
  inputSelector: '#search',
  debug: false // Set debug to true if you want to inspect the dropdown
});
</script>
</body>
</html>